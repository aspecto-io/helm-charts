{{- $root := . -}}
{{- $globalMetadata := .Values.global.metadata -}}
{{- $globalSharedLabels := $globalMetadata.shared.labels -}}
{{- $globalObjectLabels := $globalMetadata.virtualService.labels }}
{{- $globalSharedAnnotations := $globalMetadata.shared.annotations }}
{{- $globalObjectAnnotations := $globalMetadata.virtualService.annotations }}
{{- $localMetadata := .Values.load_balancer.metadata -}}
{{- $localSharedAnnotations := $localMetadata.shared.annotations -}}
{{- $localObjectAnnotations := $localMetadata.virtualService.annotations -}}
{{- $localSharedLabels := $localMetadata.shared.labels -}}
{{- $localObjectLabels := $localMetadata.virtualService.labels -}}
{{- if .Values.load_balancer.specs.network.istio.enabled }}
{{- range .Values.load_balancer.specs.network.istio.rules }}

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ $root.Values.global.name }}-vsvc
  labels: {{ tpl ( toYaml $globalSharedLabels | nindent 4) $ }}
{{- if $globalObjectLabels }}{{ tpl ( toYaml $globalObjectLabels | nindent 4) . }}{{- end }}
{{- if $localObjectLabels }}{{ toYaml $localObjectLabels | nindent 4 }}{{- end }}
{{- if $localObjectLabels }}{{ toYaml $localObjectLabels | nindent 4 }}{{- end }}
  annotations: {{ tpl ( toYaml $globalSharedAnnotations | nindent 4) $ }}
{{- if $globalObjectAnnotations }}{{ tpl ( toYaml $globalObjectAnnotations | nindent 4) . }}{{- end }}
{{- if $localSharedAnnotations }}{{ toYaml $localSharedAnnotations | nindent 4 }}{{- end }}
{{- if $localObjectAnnotations }}{{ toYaml $localObjectAnnotations | nindent 4 }}{{- end }}
spec:
  hosts:
  {{ toYaml .hostHeader | trim | indent 4 }}
  gateways:
    - grpc-{{ $root.Values.global.namespace }}-gateway
  http:
  {{- range .ingress }}
    - match:
      - uri:
          prefix: {{ .uriPrefix }}
      route:
      - destination:
          host: {{ tpl ( .host ) $ }}
          port:
            number: {{ .destinationPort }}
  {{- end }}
{{- end }}
{{- end }}