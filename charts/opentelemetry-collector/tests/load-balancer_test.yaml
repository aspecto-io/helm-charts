name: aspecto-otel-load-balancer-deployment
name: aspecto-otel-load-balancer-hpa
name: aspecto-otel-load-balancer-loadBalancer-service
name: aspecto-otel-load-balancer-service-configuration
name: aspecto-otel-sampling-collector-deployment
name: aspecto-otel-sampling-collector-hpa
name: aspecto-otel-sampling-collector-service-configuration
name: aspecto-otel-sampling-collector-tail-sampling-service

suite: test load-balancer deployment
templates:
  - load-balancer/deployment.yaml
  - load-balancer/configMap.yaml
  - load-balancer/service.yaml
  - load-balancer/hpa.yaml
  - load-balancer/virtualService.yaml
  - load-balancer/destinationRule.yaml
  - load-balancer/gateway.yaml
tests:
  - it: load-balancer-deployment
    template: load-balancer/deployment.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal: 
          path: metadata.name
          value: otel-collector-load-balancer-deployment
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: .*otelcol-loadbalancing:latest
  - it: load-balancer-service/virtualService.yaml
    template: load-balancer/service.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    asserts:
      - isKind: 
          of: Service
      - equal:
          path: spec.type
          value: LoadBalancer
  - it: load-balancer-hpa
    template: load-balancer/hpa.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      load_balancer.specs.autoscaling.enable: true
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
  - it: load-balancer-virtualService
    template: load-balancer/virtualService.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      load_balancer.specs.network.istio.enabled: true
    asserts:
      - isKind:
          of: VirtualService
      - isAPIVersion:
          of: networking.istio.io/v1
  - it: load-balancer-destinationRule
    template: load-balancer/destinationRule.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      load_balancer.specs.network.istio.enabled: true
      load_balancer.specs.services.[0].serviceType: LoadBalancer
    asserts:
      - isKind:
          of: DestinationRule
  - it: load-balancer-gateway
    template: load-balancer/gateway.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      load_balancer.specs.network.istio.enabled: true
    asserts:
      - isKind:
          of: Gateway