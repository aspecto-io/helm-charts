suite: test sampling-service deployment
templates:
  - sampling-service/deployment.yaml
  - sampling-service/configMap.yaml
  - sampling-service/service.yaml
  - sampling-service/hpa.yaml
  - sampling-service/virtualService.yaml
  - sampling-service/destinationRule.yaml
  - sampling-service/gateway.yaml
tests:
  - it: sampling-service-deployment
    template: sampling-service/deployment.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal: 
          path: metadata.name
          value: otel-collector-sampling-collector-deployment
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: .*otelcol-sampling:latest
  - it: sampling-service-service/virtualService.yaml
    template: sampling-service/service.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    asserts:
      - isKind: 
          of: Service
      - equal:
          path: spec.type
          value: ClusterIP
  - it: sampling-service-hpa
    template: sampling-service/hpa.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      sampling_collector.specs.autoscaling.enable: true
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
  - it: sampling-service-virtualService
    template: sampling-service/virtualService.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      sampling_collector.specs.network.istio.enabled: true
    asserts:
      - isKind:
          of: VirtualService
      - isAPIVersion:
          of: networking.istio.io/v1
  - it: sampling-service-destinationRule
    template: sampling-service/destinationRule.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      sampling_collector.specs.network.istio.enabled: true
      sampling_collector.specs.services.[0].serviceType: LoadBalancer
    asserts:
      - isKind:
          of: DestinationRule
  - it: sampling-service-gateway
    template: sampling-service/gateway.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      sampling_collector.specs.network.istio.enabled: true
    asserts:
      - isKind:
          of: Gateway