suite: test sampling-service deployment
templates:
  - collector/deployment.yaml
  - collector/configMap.yaml
  - collector/service.yaml
  - collector/hpa.yaml
  - collector/virtualService.yaml
  - collector/destinationRule.yaml
  - collector/gateway.yaml
tests:
  - it: collector-deployment
    template: collector/deployment.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal: 
          path: metadata.name
          value: otel-collector-collector-deployment
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: .*otelcol-sampling:latest
  - it: collector-service/virtualService.yaml
    template: collector/service.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    asserts:
      - isKind: 
          of: Service
      - equal:
          path: spec.type
          value: ClusterIP
  - it: collector-hpa
    template: collector/hpa.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      collector.specs.autoscaling.enable: true
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
  - it: collector-virtualService
    template: collector/virtualService.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      collector.specs.network.istio.enabled: true
    asserts:
      - isKind:
          of: VirtualService
      - isAPIVersion:
          of: networking.istio.io/v1
  - it: collector-destinationRule
    template: collector/destinationRule.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      collector.specs.network.istio.enabled: true
      collector.specs.services.[0].serviceType: LoadBalancer
    asserts:
      - isKind:
          of: DestinationRule
  - it: collector-gateway
    template: collector/gateway.yaml
    values:
      - ../values.yaml
      - tests_values.yaml
    set:
      collector.specs.network.istio.enabled: true
    asserts:
      - isKind:
          of: Gateway